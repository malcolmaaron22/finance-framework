<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CafÃ© Finance Framework (MYR) â€” Tooltips & CSV</title>
  <style>
    /* * Global CSS Variables for a clean, consistent theme.
     * The colors below have been updated to the user's new HEX codes.
     */
    :root {
      --bg: #f6f7f9; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --accent:#2563eb; --accent-2:#0ea5e9; --shadow:0 10px 30px rgba(2,6,23,.08); --radius:16px;
      /* Updated colors for financial metrics based on user's request */
      --rev:#00d9ff; --opex:#fbbf24; --net:#10b981; --net-neg:#f43f5e; --tax:#ef4444; --reinvest:#8b5cf6; --dist:#a3e635; 
      /* Other status colors */
      --ok:#16a34a; --paused:#ef4444; --f1:#60a5fa; --f2:#f472b6; --f3:#a78bfa;
    }
    @media (prefers-color-scheme: dark){:root{--bg:#0b1220;--panel:#0f172a;--card:#111a2e;--text:#e6edf7;--muted:#94a3b8;--border:#1f2a44;--shadow:0 10px 30px rgba(0,0,0,.4)}}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
    .app{display:grid;grid-template-columns:400px 1fr;min-height:100dvh}
    @media (max-width:960px){.app{grid-template-columns:1fr}}
    aside.panel{position:sticky;top:0;align-self:start;height:100dvh;overflow:auto;padding:20px;background:var(--panel);border-right:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:12px}.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(37, 99, 235, 0.18);}
    .brand h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin:0 0 18px}
    .group{border:1px dashed var(--border);border-radius:14px;padding:14px;margin:14px 0;background:rgba(255, 255, 255, 0.08);}
    .group h2{font-size:13px;margin:0 0 10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.06em}
    label.row{display:flex;flex-direction:column;gap:8px;padding:8px 0}
    .row-inputs {display: grid;grid-template-columns: 1fr 160px;align-items: center;gap: 8px;}
    .row small{color:var(--muted)} input[type=number],input[type=text],input[type=range]{width:100%}
    input[type=number]{appearance:textfield;-moz-appearance:textfield;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);outline:none;box-shadow:inset 0 0 0 1px transparent}
    input[type=number]:focus{box-shadow:inset 0 0 0 1px var(--accent);border-color:rgba(37, 99, 235, 0.4);}
    .switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}.switch input{display:none}.track{width:40px;height:22px;background:#cbd5e1;border-radius:999px;position:relative;transition:.2s ease}.thumb{position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.2s ease;box-shadow:0 1px 2px rgba(0,0,0,.2)} .switch input:checked+.track{background:var(--accent)} .switch input:checked+.track .thumb{left:21px}
    .founder-grid{display:grid;grid-template-columns:1fr 60px;gap:8px 10px;align-items:center}.founder-grid .name{font-weight:600}.founder-grid input[type=range]{grid-column:1/-1}
    .total{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}.total strong{color:var(--text)}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)} button.primary{background:var(--accent);color:#fff;border-color:rgba(37, 99, 235, 0.5);} button.icon{display:flex;align-items:center;gap:8px}
    section.content{padding:24px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;min-height:80px}
    .kpi{display:flex;flex-direction:column;gap:4px}.kpi .label{color:var(--muted);font-size:12px;display:flex;align-items:center;gap:8px}.kpi .value{font-size:20px;font-weight:700;letter-spacing:.3px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:600;font-size:12px}
    .chip.ok{background:rgba(22, 163, 74, 0.14);color:var(--ok);border:1px solid rgba(22, 163, 74, 0.4);}
    .chip.paused{background:rgba(239, 68, 68, 0.14);color:var(--paused);border:1px solid rgba(239, 68, 68, 0.4);}
    .dot{width:8px;height:8px;border-radius:50%;background:currentColor}
    .legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px}.legend .item{display:flex;align-items:center;gap:8px;font-size:12px}.swatch{width:12px;height:12px;border-radius:3px}
    .stack{width:100%;height:32px;background:#e5e7eb;border-radius:999px;overflow:hidden;border:1px solid var(--border)} @media (prefers-color-scheme: dark){.stack{background:#0f172a}}
    .seg{height:100%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;white-space:nowrap}.seg.tax{background:var(--tax)}.seg.reinvest{background:var(--reinvest)}.seg.dist{background:var(--dist)}
    .gauge{width:100%;height:12px;border-radius:999px;background:#e5e7eb;overflow:hidden;border:1px solid var(--border)} @media (prefers-color-scheme: dark){.gauge{background:#0f172a}} .gauge .fill{height:100%;background:var(--ok);width:50%}
    .gauge .fill.alert { background: var(--paused); }
    .donut-wrap{display:grid;grid-template-columns:200px 1fr;gap:16px;align-items:center} @media (max-width:700px){.donut-wrap{grid-template-columns:1fr}}
    svg.donut{width:200px;height:200px} .center-text{font:700 14px/1.2 system-ui;fill:var(--text);text-anchor:middle;dominant-baseline:middle}
    .muted{color:var(--muted)}
    .span-3{grid-column:span 3}.span-4{grid-column:span 4}.span-6{grid-column:span 6}.span-8{grid-column:span 8}.span-12{grid-column:span 12}
    @media (max-width:1200px){
      .span-6,.span-8{grid-column:span 12}
    } @media (max-width:900px){
      .span-3,.span-4{grid-column:span 6}
    } @media (max-width:600px){
      .span-3,.span-4{grid-column:span 12}
    }
    /* Financial Overview bar chart */
    .bar-chart{display:grid;gap:10px}
    .bar{display:flex;align-items:center;gap:10px}
    .bar-label{width:140px;font-weight:600}
    .bar-track{flex:1;height:28px;background:#e2e8f0;border-radius:8px;overflow:hidden;position:relative;border:1px solid var(--border)} @media (prefers-color-scheme: dark){.bar-track{background:#0f172a}}
    .bar-fill{height:100%;border-radius:8px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;color:#fff;font-size:13px;font-weight:600}
    /* Updated bar fill colors to match user's request */
    .bar-fill.rev{background:var(--rev)} .bar-fill.opex{background:var(--opex)} .bar-fill.net{background:var(--net)} .bar-fill.net.neg{background:var(--net-neg)} .bar-fill.tax{background:var(--tax)} .bar-fill.rei{background:var(--reinvest)} .bar-fill.dist{background:var(--dist)}

    /* Tiny info tooltip */
    .info{display:inline-flex;width:18px;height:18px;border-radius:50%;align-items:center;justify-content:center;background:rgba(37, 99, 235, 0.2);color:var(--accent);font-size:12px;cursor:help;position:relative}
    .info .tip{position:absolute;left:50%;top:120%;transform:translateX(-50%);min-width:220px;max-width:320px;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);padding:10px;border-radius:10px;color:var(--text);opacity:0;pointer-events:none;transition:.12s;z-index:10}
    .info:hover .tip{opacity:1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px}

    /* Styles for print mode */
    @media print{
      body{
        /* Center the content for print */
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      /* Hide the left panel and set the grid to display as a block */
      .app{
        display:block
      }
      aside.panel{
        display:none!important;
      }
      /* The content section will now take up the full page width */
      section.content{
        width: 100%;
      }
      /* Hide buttons, switches, and range inputs for a clean printout */
      .btns,.switch,input[type=range]{
        display:none!important
      }
      /* Ensure the group borders are solid for printing */
      .group{
        border:1px solid var(--border)
      }
      /* Set the print page size to A4 landscape with a 10mm margin */
      @page{
        size:A4 landscape;
        margin:10mm
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel">
      <div class="brand"><span class="dot"></span><h1>CafÃ© Finance Framework (MYR)</h1></div>
      <p class="sub">Live calculator for monthly performance. All values are monthly unless stated.</p>
      <div class="group">
        <h2>Business Inputs</h2>
        <!-- Added slider for Estimated Revenue -->
        <label class="row">Estimated Revenue (MYR)
          <div class="row-inputs">
            <input id="revenue" type="number" min="0" step="100" value="60000" />
            <input id="revenueRange" type="range" min="0" max="200000" step="100" value="60000" />
          </div>
          <small>Projected gross monthly sales.</small>
        </label>
        <!-- Added slider for Monthly OPEX -->
        <label class="row">Monthly OPEX (MYR)
          <div class="row-inputs">
            <input id="opex" type="number" min="0" step="100" value="40000" />
            <input id="opexRange" type="range" min="0" max="100000" step="100" value="40000" />
          </div>
          <small>All operating expenses (rent, payroll, utilities, etc.).</small>
        </label>
        <!-- Added slider for Cash on Hand -->
        <label class="row">Cash on Hand (MYR)
          <div class="row-inputs">
            <input id="cash" type="number" min="0" step="100" value="80000" />
            <input id="cashRange" type="range" min="0" max="200000" step="100" value="80000" />
          </div>
          <small>Available cash. Used to compute runway/emergency: <em>Cash Ã· OPEX</em>.</small>
        </label>
      </div>
      <div class="group">
        <h2>Policy</h2>
        <label class="row">Reinvestment %
          <input id="reinvestPct" type="number" min="0" max="100" step="1" value="20" />
          <small>Percentage of profit (after tax) to put back into the business.</small>
        </label>
        <label class="row">Income Tax %
          <span style="display:flex; gap:8px; align-items:center;">
            <label class="switch" title="Toggle tax on/off">
              <input id="taxEnable" type="checkbox" checked>
              <span class="track"><span class="thumb"></span></span>
            </label>
            <input id="taxPct" type="number" min="0" max="30" step="0.1" value="17" title="Tax %" />
          </span>
          <small>Applied only when profit is positive.</small>
        </label>
        <label class="row">Reserve Target (months)
          <input id="reserve" type="number" min="0" step="0.5" value="3" />
          <small>Minimum cash runway to allow distributions.</small>
        </label>
        <label class="row">Autoâ€‘pause Dividends
          <label class="switch" title="Prevent distributions when runway &lt; target">
            <input id="autopause" type="checkbox" checked>
            <span class="track"><span class="thumb"></span></span>
          </label>
          <small>When active and runway is short, distributions are set to MYR 0.</small>
        </label>
      </div>
      <div class="group">
        <h2>Founders' Distribution (%)</h2>
        <div class="founder-grid">
          <div class="name">Founder 1</div>
          <input id="f1Num" type="number" min="0" max="100" step="1" value="35">
          <input id="f1" type="range" min="0" max="100" step="1" value="35" data-index="0">
          <div class="name">Founder 2</div>
          <input id="f2Num" type="number" min="0" max="100" step="1" value="35">
          <input id="f2" type="range" min="0" max="100" step="1" value="35" data-index="1">
          <div class="name">Founder 3</div>
          <input id="f3Num" type="number" min="0" max="100" step="1" value="30">
          <input id="f3" type="range" min="0" max="100" step="1" value="30" data-index="2">
        </div>
        <div class="total"><span>Total must be <strong>100%</strong>.</span><span id="totalPct">100%</span></div>
      </div>
      <div class="btns">
        <button class="icon" id="resetBtn" title="Reset to defaults">â†º Reset</button>
        <button class="icon primary" id="exportBtn" title="Export as PNG">ðŸ¡‡ Export PNG</button>
        <button class="icon" id="csvBtn" title="Export a CSV snapshot of current inputs & outputs">â¬‡ï¸Ž Export CSV</button>
      </div>
    </aside>

    <section class="content" id="content-to-capture">
      <div class="grid">
        <!-- Rearranged KPI Cards to match the requested order -->
        <div class="card kpi span-3" style="border-left:5px solid var(--rev)">
          <div class="label">Revenue</div>
          <div class="value" id="outRevenue">â€“</div>
          <div class="muted">Projected gross sales.</div>
        </div>
        <div class="card kpi span-3" style="border-left:5px solid var(--opex)">
          <div class="label">OPEX</div>
          <div class="value" id="outOpex">â€“</div>
          <div class="muted">Operating costs.</div>
        </div>
        <!-- Net Profit KPI card with dynamic color -->
        <div class="card kpi span-3" id="netProfitCard">
          <div class="label">Net Profit <span class="info"><span>i</span><span class="tip"><strong>Formula</strong><br><span class="mono">net = revenue âˆ’ opex</span></span></span></div>
          <div class="value" id="outNet">â€“</div>
          <div class="muted" id="netNote">Revenue âˆ’ OPEX.</div>
        </div>
        <div class="card kpi span-3" style="border-left:5px solid var(--tax)">
          <div class="label">Income Tax <span class="info" aria-label="formula"><span>i</span><span class="tip"><strong>Formula</strong><br><span class="mono">tax = max(0, net) Ã— tax%</span><br>Only when tax is enabled.</span></span></div>
          <div class="value" id="outTax">â€“</div>
          <div class="muted" id="taxLabel">Based on positive profit.</div>
        </div>
        <div class="card kpi span-4" style="border-left:5px solid var(--reinvest)">
          <div class="label">Reinvestment <span class="info" aria-label="formula"><span>i</span><span class="tip"><strong>Formula</strong><br><span class="mono">reinvestment = max(0, net âˆ’ tax) Ã— reinvest%</span></span></span></div>
          <div class="value" id="outReinvest">â€“</div>
          <div class="muted" id="reinLabel">% of profit after tax.</div>
        </div>
        <div class="card kpi span-4" style="border-left:5px solid var(--dist)">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div class="label">Distributable Profit <span class="info"><span>i</span><span class="tip"><strong>Formula</strong><br><span class="mono">dist = max(0, net âˆ’ tax âˆ’ reinvest)</span><br>Set to 0 if dividends are paused.</span></span></div>
              <div class="value" id="outDist">â€“</div>
            </div>
            <span id="statusChip" class="chip ok"><span class="dot"></span> <span id="statusText">OK</span></span>
          </div>
          <div class="muted">After tax and reinvestment; set to MYR 0 when dividends are paused.</div>
        </div>

        <div class="card span-4">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div style="font-weight:700;display:flex;align-items:center;gap:8px;">Runway <span class="info"><span>i</span><span class="tip"><span><strong>Formula</strong><br><span class="mono">runway (months) = cash Ã· opex</span><br><span class="mono">status = paused if runway &lt; reserveTarget AND autopause</span></span></span></div>
            <div id="runwayNums" class="muted">â€“</div>
          </div>
          <div class="gauge" aria-label="Runway vs Target">
            <div id="gaugeFill" class="fill" style="width:0%"></div>
          </div>
          <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;" class="legend">
            <div class="item"><span class="swatch" style="background:var(--ok)"></span><span>Runway/Target</span></div>
            <div class="item"><span class="swatch" style="background:var(--paused)"></span><span>Below Target</span></div>
          </div>
        </div>
        <!-- Financial Overview Bar Chart -->
        <div class="card span-8">
          <div style="font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px;">Financial Overview <span class="info"><span>i</span><span class="tip"><strong>Notes</strong><br>Bars auto-scale to the largest absolute value among Revenue, OPEX, Net, Tax, Reinvest.</span></span></div>
          <div class="bar-chart">
            <div class="bar"><div class="bar-label">Revenue</div><div class="bar-track"><div id="barRev" class="bar-fill rev" style="width:0%">MYR 0</div></div></div>
            <div class="bar"><div class="bar-label">OPEX</div><div class="bar-track"><div id="barOpex" class="bar-fill opex" style="width:0%">MYR 0</div></div></div>
            <!-- Bar for Net Profit with dynamic color class -->
            <div class="bar"><div class="bar-label">Net Profit</div><div class="bar-track"><div id="barNet" class="bar-fill net" style="width:0%">MYR 0</div></div></div>
            <div class="bar"><div class="bar-label">Income Tax</div><div class="bar-track"><div id="barTax" class="bar-fill tax" style="width:0%">MYR 0</div></div></div>
            <div class="bar"><div class="bar-label">Reinvest</div><div class="bar-track"><div id="barRei" class="bar-fill rei" style="width:0%">MYR 0</div></div></div>
            <div class="bar"><div class="bar-label">Distributable Profit</div><div class="bar-track"><div id="barDist" class="bar-fill dist" style="width:0%">MYR 0</div></div></div>
          </div>
          <div class="muted" style="margin-top:8px;">Negative net values show with a leading minus sign on the bar label.</div>
        </div>
        <!-- Donut + Founder Cards -->
        <div class="card span-4">
          <div style="font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px;">Founders' Payouts <span class="info"><span>i</span><span class="tip"><strong>Notes</strong><br>Calculated as a share of Distributable Profit.</span></span></div>
          <div class="donut-wrap">
            <svg class="donut" viewBox="0 0 240 240">
              <g transform="translate(120, 120) rotate(-90)">
                <circle cx="0" cy="0" r="100" fill="none" stroke="#e2e8f0" stroke-width="30" />
                <circle id="donut-f1" class="donut-f1" cx="0" cy="0" r="100" fill="none" stroke="var(--f1)" stroke-width="30" stroke-dasharray="0 628.3" stroke-dashoffset="0" />
                <circle id="donut-f2" class="donut-f2" cx="0" cy="0" r="100" fill="none" stroke="var(--f2)" stroke-width="30" stroke-dasharray="0 628.3" stroke-dashoffset="0" />
                <circle id="donut-f3" class="donut-f3" cx="0" cy="0" r="100" fill="none" stroke="var(--f3)" stroke-width="30" stroke-dasharray="0 628.3" stroke-dashoffset="0" />
              </g>
              <text id="donut-val" class="center-text" transform="translate(120, 120)">â€“</text>
            </svg>
            <div class="legend">
              <div class="item"><span class="swatch" style="background:var(--f1)"></span><span id="f1Out">F1: MYR 0</span></div>
              <div class="item"><span class="swatch" style="background:var(--f2)"></span><span id="f2Out">F2: MYR 0</span></div>
              <div class="item"><span class="swatch" style="background:var(--f3)"></span><span id="f3Out">F3: MYR 0</span></div>
            </div>
          </div>
          <div style="margin-top:8px;font-size:12px;color:var(--muted);text-align:center;">
            Total payouts: <strong id="totalPayout" style="color:var(--text)">MYR 0</strong>
          </div>
        </div>
      </div>
    </section>
  </div>
  <script>
    // General helper function to format numbers as Malaysian Ringgit (MYR)
    const formatMYR = (num) => {
        // Return MYR 0 for non-finite values to prevent "NaN"
        if (!isFinite(num)) {
            return 'MYR 0';
        }
        // Use Intl.NumberFormat for proper currency formatting.
        return new Intl.NumberFormat('en-MY', {
            style: 'currency',
            currency: 'MYR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(num);
    };

    // Helper to format months
    const formatMonths = (num) => {
      if (!isFinite(num)) return 'â€“';
      return `${num.toFixed(1)} months`;
    };

    // Helper to update the text content of an element
    const updateText = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };

    // Input elements from the sidebar
    const inputs = {
      revenue: document.getElementById('revenue'),
      revenueRange: document.getElementById('revenueRange'),
      opex: document.getElementById('opex'),
      opexRange: document.getElementById('opexRange'),
      cash: document.getElementById('cash'),
      cashRange: document.getElementById('cashRange'),
      reinvestPct: document.getElementById('reinvestPct'),
      taxEnable: document.getElementById('taxEnable'),
      taxPct: document.getElementById('taxPct'),
      reserve: document.getElementById('reserve'),
      autopause: document.getElementById('autopause'),
      f1Num: document.getElementById('f1Num'),
      f2Num: document.getElementById('f2Num'),
      f3Num: document.getElementById('f3Num'),
      f1: document.getElementById('f1'),
      f2: document.getElementById('f2'),
      f3: document.getElementById('f3'),
    };

    // Output elements on the dashboard
    const outputs = {
      outRevenue: document.getElementById('outRevenue'),
      outOpex: document.getElementById('outOpex'),
      outNet: document.getElementById('outNet'),
      outTax: document.getElementById('outTax'),
      outReinvest: document.getElementById('outReinvest'),
      outDist: document.getElementById('outDist'),
      statusChip: document.getElementById('statusChip'),
      statusText: document.getElementById('statusText'),
      runwayNums: document.getElementById('runwayNums'),
      gaugeFill: document.getElementById('gaugeFill'),
      netProfitCard: document.getElementById('netProfitCard'),
      barRev: document.getElementById('barRev'),
      barOpex: document.getElementById('barOpex'),
      barNet: document.getElementById('barNet'),
      barTax: document.getElementById('barTax'),
      barRei: document.getElementById('barRei'),
      barDist: document.getElementById('barDist'),
      donutF1: document.getElementById('donut-f1'),
      donutF2: document.getElementById('donut-f2'),
      donutF3: document.getElementById('donut-f3'),
      donutVal: document.getElementById('donut-val'),
      f1Out: document.getElementById('f1Out'),
      f2Out: document.getElementById('f2Out'),
      f3Out: document.getElementById('f3Out'),
      totalPayout: document.getElementById('totalPayout'),
    };

    // Main calculation and render function
    const calculateAndRender = () => {
      // Get input values from elements
      const revenue = parseFloat(inputs.revenue.value) || 0;
      const opex = parseFloat(inputs.opex.value) || 0;
      const cash = parseFloat(inputs.cash.value) || 0;
      const reinvestPct = parseFloat(inputs.reinvestPct.value) / 100;
      const taxEnabled = inputs.taxEnable.checked;
      const taxPct = parseFloat(inputs.taxPct.value) / 100;
      const reserveTarget = parseFloat(inputs.reserve.value) || 0;
      const autopause = inputs.autopause.checked;

      // KPI Calculations
      const netProfit = revenue - opex;
      const incomeTax = taxEnabled && netProfit > 0 ? netProfit * taxPct : 0;
      const profitAfterTax = netProfit - incomeTax;
      const reinvestment = profitAfterTax > 0 ? profitAfterTax * reinvestPct : 0;
      const distributableProfit = profitAfterTax - reinvestment;
      const runwayMonths = opex > 0 ? cash / opex : Infinity;

      // Payouts based on founder percentages
      const founders = [
        parseFloat(inputs.f1Num.value) / 100,
        parseFloat(inputs.f2Num.value) / 100,
        parseFloat(inputs.f3Num.value) / 100,
      ];

      // Handle autopause logic
      let finalDistributableProfit = distributableProfit;
      if (autopause && runwayMonths < reserveTarget) {
          finalDistributableProfit = 0;
          outputs.statusChip.classList.remove('ok');
          outputs.statusChip.classList.add('paused');
          outputs.statusText.textContent = 'PAUSED';
      } else {
          outputs.statusChip.classList.remove('paused');
          outputs.statusChip.classList.add('ok');
          outputs.statusText.textContent = 'OK';
      }

      const payouts = founders.map(f => finalDistributableProfit * f);
      const totalPayout = payouts.reduce((sum, current) => sum + current, 0);

      // Render KPIs
      updateText('outRevenue', formatMYR(revenue));
      updateText('outOpex', formatMYR(opex));
      updateText('outNet', formatMYR(netProfit));
      updateText('outTax', formatMYR(incomeTax));
      updateText('outReinvest', formatMYR(reinvestment));
      updateText('outDist', formatMYR(finalDistributableProfit));

      // Dynamic color for Net Profit KPI card
      if (netProfit < 0) {
        outputs.netProfitCard.style.borderLeft = '5px solid var(--net-neg)';
      } else {
        outputs.netProfitCard.style.borderLeft = '5px solid var(--net)';
      }

      // Render Runway with dynamic color
      updateText('runwayNums', formatMonths(runwayMonths));
      const gaugePct = Math.min(100, (runwayMonths / reserveTarget) * 100);
      outputs.gaugeFill.style.width = `${gaugePct}%`;
      if (runwayMonths < reserveTarget) {
        outputs.gaugeFill.classList.add('alert');
      } else {
        outputs.gaugeFill.classList.remove('alert');
      }

      // Render Bar Chart
      const valuesForBars = {
        rev: revenue,
        opex: opex,
        net: netProfit,
        tax: incomeTax,
        rei: reinvestment,
        dist: finalDistributableProfit
      };

      // Find the absolute maximum value for scaling
      const absMax = Math.max(...Object.values(valuesForBars).map(Math.abs));

      const renderBar = (id, value, label) => {
        const bar = document.getElementById(id);
        if (bar) {
          const widthPct = absMax > 0 ? (Math.abs(value) / absMax) * 100 : 0;
          bar.style.width = `${widthPct}%`;
          bar.textContent = formatMYR(value);
        }
      };

      // Render Net Profit bar with dynamic color class
      const netBar = outputs.barNet;
      if (netProfit < 0) {
        netBar.classList.add('neg');
      } else {
        netBar.classList.remove('neg');
      }

      renderBar('barRev', revenue, 'Revenue');
      renderBar('barOpex', opex, 'OPEX');
      renderBar('barNet', netProfit, 'Net Profit');
      renderBar('barTax', incomeTax, 'Income Tax');
      renderBar('barRei', reinvestment, 'Reinvestment');
      renderBar('barDist', finalDistributableProfit, 'Distributable Profit');

      // Render Donut Chart and Payouts
      const circumference = 2 * Math.PI * 100; // 628.318...
      let currentOffset = 0;
      const payoutPercentages = founders.map(f => f * finalDistributableProfit);
      const donutValues = payoutPercentages.map(payout => (payout / totalPayout) * circumference);

      if (totalPayout > 0) {
        outputs.donutF1.style.strokeDasharray = `${donutValues[0]} ${circumference}`;
        outputs.donutF1.style.strokeDashoffset = 0;
        currentOffset += donutValues[0];
        outputs.donutF2.style.strokeDasharray = `${donutValues[1]} ${circumference}`;
        outputs.donutF2.style.strokeDashoffset = -currentOffset;
        currentOffset += donutValues[1];
        outputs.donutF3.style.strokeDasharray = `${donutValues[2]} ${circumference}`;
        outputs.donutF3.style.strokeDashoffset = -currentOffset;
      } else {
        // Reset donut to empty if there's no payout
        outputs.donutF1.style.strokeDasharray = `0 ${circumference}`;
        outputs.donutF2.style.strokeDasharray = `0 ${circumference}`;
        outputs.donutF3.style.strokeDasharray = `0 ${circumference}`;
      }

      updateText('donut-val', formatMYR(totalPayout));
      updateText('f1Out', `F1: ${formatMYR(payouts[0])}`);
      updateText('f2Out', `F2: ${formatMYR(payouts[1])}`);
      updateText('f3Out', `F3: ${formatMYR(payouts[2])}`);
      updateText('totalPayout', formatMYR(totalPayout));
    };

    // Helper function to sync number inputs with their corresponding range sliders
    const syncNumbersToSliders = () => {
      inputs.revenueRange.value = inputs.revenue.value;
      inputs.opexRange.value = inputs.opex.value;
      inputs.cashRange.value = inputs.cash.value;
      inputs.f1.value = inputs.f1Num.value;
      inputs.f2.value = inputs.f2Num.value;
      inputs.f3.value = inputs.f3Num.value;
    };

    // Helper function to sync range sliders with their corresponding number inputs
    const syncSlidersToNumbers = () => {
      inputs.revenue.value = inputs.revenueRange.value;
      inputs.opex.value = inputs.opexRange.value;
      inputs.cash.value = inputs.cashRange.value;
      inputs.f1Num.value = inputs.f1.value;
      inputs.f2Num.value = inputs.f2.value;
      inputs.f3Num.value = inputs.f3.value;
    };
    
    // Add event listeners to all input fields and sliders for real-time updates
    const allInputs = document.querySelectorAll('input');
    allInputs.forEach(input => {
      input.addEventListener('input', () => {
        // Sync the opposite input type
        if (input.type === 'number' && input.id.includes('Num')) {
          const rangeId = input.id.replace('Num', '');
          const rangeEl = document.getElementById(rangeId);
          if (rangeEl) rangeEl.value = input.value;
        } else if (input.type === 'range' && input.id.includes('Range')) {
          const numberId = input.id.replace('Range', '');
          const numberEl = document.getElementById(numberId);
          if (numberEl) numberEl.value = input.value;
        }
        calculateAndRender();
      });
      // Specific handling for number inputs on 'change' to sync with sliders
      input.addEventListener('change', (event) => {
        if (event.target.type === 'number') {
            syncNumbersToSliders();
        }
        calculateAndRender();
      });
    });

    // Add specific event listeners for founder distribution sliders
    const founderSliders = [inputs.f1, inputs.f2, inputs.f3];
    const founderNumbers = [inputs.f1Num, inputs.f2Num, inputs.f3Num];

    // Function to update founder number inputs when sliders are used
    const updateFounderNumbers = (e) => {
        const index = parseInt(e.target.dataset.index, 10);
        founderNumbers[index].value = e.target.value;
    };
    
    // Function to distribute the total percentage (100%) across founders
    const distributePercentages = (sliderIndex, newTotal) => {
        const sliders = [inputs.f1, inputs.f2, inputs.f3];
        let remaining = 100 - newTotal;
        let numRemaining = 2; // Number of other sliders
        
        sliders.forEach((slider, index) => {
            if (index !== sliderIndex && numRemaining > 0) {
                // Distribute remaining value equally among other sliders
                const prevVal = parseFloat(slider.value);
                const share = remaining / numRemaining;
                slider.value = prevVal + share;
                remaining -= share;
                numRemaining--;
            }
        });
        
        // Final sanity check to ensure total is exactly 100%
        sliders[sliderIndex].value = newTotal;
        const total = parseFloat(sliders[0].value) + parseFloat(sliders[1].value) + parseFloat(sliders[2].value);
        const totalPctEl = document.getElementById('totalPct');
        totalPctEl.textContent = `${Math.round(total)}%`;
        if (Math.round(total) !== 100) {
            totalPctEl.style.color = 'var(--paused)';
        } else {
            totalPctEl.style.color = 'var(--text)';
        }
    };

    // Add input event listeners to all founder sliders to re-calculate numbers and distribute percentages
    founderSliders.forEach((slider, index) => {
        slider.addEventListener('input', (e) => {
            updateFounderNumbers(e);
            let total = 0;
            founderNumbers.forEach(num => total += parseFloat(num.value));
            document.getElementById('totalPct').textContent = `${Math.round(total)}%`;
            if (Math.round(total) > 100) {
                distributePercentages(index, parseFloat(e.target.value));
                syncSlidersToNumbers();
                calculateAndRender();
            } else {
                calculateAndRender();
            }
        });
    });

    // Add input event listeners to all founder number inputs to re-calculate and distribute percentages
    founderNumbers.forEach((numInput, index) => {
        numInput.addEventListener('input', (e) => {
            let total = 0;
            founderNumbers.forEach(num => total += parseFloat(num.value));
            document.getElementById('totalPct').textContent = `${Math.round(total)}%`;
            if (Math.round(total) > 100) {
                distributePercentages(index, parseFloat(e.target.value));
                syncNumbersToSliders();
                calculateAndRender();
            } else {
                syncNumbersToSliders();
                calculateAndRender();
            }
        });
    });

    // Event listener for the export button
    document.getElementById('exportBtn').addEventListener('click', () => {
      const content = document.getElementById('content-to-capture');
      html2canvas(content).then(canvas => {
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = image;
        link.download = `cafe_finance_${new Date().toISOString()}.png`;
        link.click();
      });
    });

    // Add the html2canvas script dynamically
    const script = document.createElement('script');
    script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
    document.head.appendChild(script);

    // CSV export button functionality
    document.getElementById('csvBtn').addEventListener('click', () => {
      // Re-run the calculation to get the latest values
      const revenue = parseFloat(inputs.revenue.value) || 0;
      const opex = parseFloat(inputs.opex.value) || 0;
      const cash = parseFloat(inputs.cash.value) || 0;
      const reinvestPct = parseFloat(inputs.reinvestPct.value) / 100;
      const taxEnabled = inputs.taxEnable.checked;
      const taxPct = parseFloat(inputs.taxPct.value) / 100;
      const reserveTarget = parseFloat(inputs.reserve.value) || 0;
      const autopause = inputs.autopause.checked;

      const netProfit = revenue - opex;
      const incomeTax = taxEnabled && netProfit > 0 ? netProfit * taxPct : 0;
      const profitAfterTax = netProfit - incomeTax;
      const reinvestment = profitAfterTax > 0 ? profitAfterTax * reinvestPct : 0;
      const distributableProfit = profitAfterTax - reinvestment;
      const runwayMonths = opex > 0 ? cash / opex : Infinity;
      const founders = [
        parseFloat(inputs.f1Num.value) / 100,
        parseFloat(inputs.f2Num.value) / 100,
        parseFloat(inputs.f3Num.value) / 100,
      ];
      let finalDistributableProfit = distributableProfit;
      if (autopause && runwayMonths < reserveTarget) {
          finalDistributableProfit = 0;
      }
      const payouts = founders.map(f => finalDistributableProfit * f);

      // Create CSV content
      const date = new Date();
      const csvRows = [
        ['"CafÃ© Finance Snapshot"'],
        ['"Date"', date.toLocaleString()],
        [''],
        ['"Input Metrics"'],
        ['"Revenue"', revenue],
        ['"OPEX"', opex],
        ['"Cash"', cash],
        ['"Reinvestment %"', reinvestPct * 100],
        ['"Income Tax %"', taxPct * 100],
        ['"Tax Enabled"', taxEnabled],
        ['"Reserve Target (months)"', reserveTarget],
        ['"Auto-pause Dividends"', autopause],
        ['"Founder 1 (%)"', founders[0] * 100],
        ['"Founder 2 (%)"', founders[1] * 100],
        ['"Founder 3 (%)"', founders[2] * 100],
        [''],
        ['"Output Metrics"'],
        ['"Net Profit"', netProfit],
        ['"Income Tax"', incomeTax],
        ['"Reinvestment"', reinvestment],
        ['"Distributable Profit"', finalDistributableProfit],
        ['"Runway (months)"', runwayMonths],
        ['"Runway Status"', runwayMonths < reserveTarget ? 'Below Target' : 'OK'],
        ['"Founder 1 Payout"', payouts[0]],
        ['"Founder 2 Payout"', payouts[1]],
        ['"Founder 3 Payout"', payouts[2]],
      ];
      const csv = csvRows.map(r=>r.join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=`cafe_finance_snapshot_${date.toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });
    
    // Reset button functionality
    document.getElementById('resetBtn').addEventListener('click', () => {
        // Hardcoded initial values
        inputs.revenue.value = 60000;
        inputs.opex.value = 40000;
        inputs.cash.value = 80000;
        inputs.reinvestPct.value = 20;
        inputs.taxEnable.checked = true;
        inputs.taxPct.value = 17;
        inputs.reserve.value = 3;
        inputs.autopause.checked = true;
        inputs.f1Num.value = 35;
        inputs.f2Num.value = 35;
        inputs.f3Num.value = 30;
        
        // Sync new number values to sliders and re-render
        syncNumbersToSliders();
        calculateAndRender();
    });

    // Initial render when the page loads
    window.onload = () => {
      calculateAndRender();
    };
  </script>
</body>
</html>
